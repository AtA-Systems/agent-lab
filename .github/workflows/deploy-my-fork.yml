# .github/workflows/deploy-my-fork.yml
name: Deploy Fork to My Firebase Hosting

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main' # Or whatever default branch they use in their fork
      channelId:
        description: 'Firebase Hosting channel ID (e.g., live, staging, or leave empty for a new preview channel)'
        required: false
        default: 'live'

jobs:
  build_and_deploy_fork:
    # Corrected: Ensure FIREBASE_CONFIG_JSON is not empty using ${{ }}
    if: ${{ secrets.FIREBASE_CONFIG_JSON != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout specific branch from fork
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }} # Checkout the branch specified in manual trigger

      - name: Create Firebase Config file and Extract Project ID
        id: setup_firebase
        env:
          # Pass the secret as an environment variable for safer handling in the script
          FIREBASE_CONFIG_JSON_FROM_SECRET: ${{ secrets.FIREBASE_CONFIG_JSON }}
        run: |
          echo "Attempting to create firebaseConfig.json and extract projectId..."
          # Check if the environment variable is set (which means the secret was not empty)
          if [ -z "$FIREBASE_CONFIG_JSON_FROM_SECRET" ]; then
            echo "Error: FIREBASE_CONFIG_JSON secret is empty or not properly passed as an environment variable."
            exit 1
          fi

          mkdir -p src # Ensure the src directory exists
          echo "$FIREBASE_CONFIG_JSON_FROM_SECRET" > src/firebaseConfig.json

          PROJECT_ID_VALUE=$(echo "$FIREBASE_CONFIG_JSON_FROM_SECRET" | jq -r .projectId)

          if [ -z "$PROJECT_ID_VALUE" ] || [ "$PROJECT_ID_VALUE" == "null" ]; then
            echo "Error: projectId not found or is null in FIREBASE_CONFIG_JSON."
            # Avoid logging the full secret. The check for emptiness is key.
            # If absolutely necessary for debugging, one might log a small, non-sensitive part.
            # For example: echo "First 50 chars of config: $(echo "$FIREBASE_CONFIG_JSON_FROM_SECRET" | cut -c 1-50)..."
            exit 1
          fi
          echo "Extracted PROJECT_ID: ${PROJECT_ID_VALUE}"
          echo "PROJECT_ID=${PROJECT_ID_VALUE}" >> $GITHUB_ENV
          echo "project_id_extracted=${PROJECT_ID_VALUE}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install Dependencies and Build
        run: |
          npm install
          npm run build

      - name: Deploy to My Firebase Hosting
        # Corrected: Use ${{ }} for the entire expression
        # This step only runs if the service account secret is present AND a valid projectId was extracted.
        if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_AGENT_WEB_UI != '' && env.PROJECT_ID != '' && steps.setup_firebase.outputs.project_id_extracted != '' }}
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_AGENT_WEB_UI }}'
          # Use the channelId from the manual trigger input.
          # If empty, the action creates a preview channel. 'live' for production.
          channelId: ${{ github.event.inputs.channelId }}
          projectId: ${{ env.PROJECT_ID }} # Use the extracted project ID  